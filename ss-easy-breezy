#!/bin/bash
#
# https://github.com/jinndi/wg-easy-breezy
#
# Copyright (c) 2025 Jinndi <alncores@gmail.ru>
#
# Released under the MIT License, see the accompanying file LICENSE
# or https://opensource.org/licenses/MIT

## –ù–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ APT
export DEBIAN_FRONTEND=noninteractive
export DEBCONF_NONINTERACTIVE_SEEN=true

## –ü—É—Ç–∏ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

## –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –≤–µ—Ä—Å–∏—è Shadowsocks-rust  
# https://github.com/shadowsocks/shadowsocks-rust/releases/
version="v1.23.4"

## –ü—É—Ç–∏ —Ñ–∞–π–ª–æ–≤:
# - –ø–∞–ø–∫–∞ —Å –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ Shadowsocks-rust
path_shadowsocks_rust="/opt/shadowsocks-rust"
# - —Ñ–∞–π–ª ssserver (—Å–µ—Ä–≤–µ—Ä Shadowsocks-rust)
path_ssserver="$path_shadowsocks_rust/ssserver"
# - —Ñ–∞–π–ª ssservice (Shadowsocks-rust —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π )
path_ssservice="$path_shadowsocks_rust/ssservice"
# - —Ñ–∞–π–ª ssurl ( Shadowsocks-rust —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫)
path_ssurl="$path_shadowsocks_rust/ssurl"
# - —Ñ–∞–π–ª —Å–ª—É–∂–±—ã –∑–∞–ø—É—Å–∫–∞ shadowsocks-rust —Å–µ—Ä–≤–µ—Ä–∞
path_service="/etc/systemd/system/ssserver.service"
# - —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥–∞ shadowsocks-rust
path_config="$path_shadowsocks_rust/config.json"
# - —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Å—ã–ª–∫–∏ –∫–ª–∏–µ–Ω—Ç—É
path_client_for_url_config="$path_shadowsocks_rust/config_url_link.json"
# - —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥–∞ sysctl
path_sysctl_config="/etc/sysctl.d/99-ss-easy-breezy.conf"
# - –º–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
path_script="$path_shadowsocks_rust/ss-easy-breezy"
# - –º–µ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏ –Ω–∞ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç
path_script_link="/usr/bin/sseb"


## –®–∏—Ñ—Ä, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Å–ª–µ–¥—É—é—â–∏–µ –≤ –ø–æ—Ä—è–¥–∫–µ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä:
# -- chacha20-ietf-poly1305
# -- aes-128-gcm
# -- aes-256-gcm
encrypt_method="chacha20-ietf-poly1305"

## –ù–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞
password=""

## –§—É–Ω–∫—Ü–∏–∏ –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:
# - —à–∞–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
show_header() {
echo -e "\033[1;35m"
cat <<EOF
###################################################
#                  SS-EASY-BREEZY                 #
# GitHub:https://github.com/jinndi/wg-easy-breezy #
###################################################
EOF
echo -e "\033[0m"
}
# - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —á–µ—Ä–µ–∑ –∑–∞–¥–µ—Ä–∂–∫—É
echomsg() {
  if [ -n "$2" ]; then
    echo
  fi
  
  echo -e "\033[1;34m$1\033[0m"
}
# - –æ–± —É—Å–ø–µ—Ö–µ
echook() {
  echo -e "\033[1;32m$1\033[0m"
}
# - –æ–± –æ—à–∏–±–∫–µ
echoerr () {
  echo -e "\033[1;31m$1\033[0m"
}
# - –æ–± –æ—à–∏–±–∫–µ —Å –≤—ã—Ö–æ–¥–æ–º –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞
exiterr() {
  echo -e "\033[1;31m–û—à–∏–±–∫–∞: $1\033[0m" >&2
  exit 1
}


## –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
# - —Ä—É—Ç –ø—Ä–∞–≤–∞
check_root() {
  if [ "$(id -u)" != 0 ]; then
    exiterr "–≠—Ç–æ—Ç —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç –∏–º–µ–Ω–∏ root. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ 'sudo bash $0'"
  fi
}

# - —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ —á–µ—Ä–µ–∑ bash –∞ –Ω–µ sh
check_shell() {
  if readlink /proc/$$/exe | grep -q "dash"; then
    exiterr '–≠—Ç–æ—Ç —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å –ø–æ–º–æ—â—å—é ¬´bash¬ª, –∞ –Ω–µ ¬´sh¬ª.'
  fi
}

# - –≤–∏–¥ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞ –û–°
check_os() {
  if grep -qs "ubuntu" /etc/os-release; then
    os="ubuntu"
    os_version=$(grep 'VERSION_ID' /etc/os-release | cut -d '"' -f 2 | tr -d '.')
  elif [[ -e /etc/debian_version ]]; then
    os="debian"
    os_version=$(grep -oE '[0-9]+' /etc/debian_version | head -1)
  else
    exiterr "–≠—Ç–æ—Ç —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—ã Ubuntu –∏ Debian!"
  fi
}

# - –≤–µ—Ä—Å–∏—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞ –û–°
check_os_ver() {
  if [[ "$os" == "ubuntu" && "$os_version" -lt 2404 ]]; then
    exiterr "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è Ubuntu 24.04 –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω—è—è –≤–µ—Ä—Å–∏—è."
  fi
  if [[ "$os" == "debian" && "$os_version" -lt 12 ]]; then
    exiterr "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è Debian 12 –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω—è—è –≤–µ—Ä—Å–∏—è."
  fi
}

# - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–∏ —è–¥—Ä–∞
check_kernel() {
  if [[ $(uname -r | cut -d "." -f 1) -lt 6 ]]; then
     exiterr "–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —è–¥—Ä–æ –û–° –≤–µ—Ä—Å–∏–∏ >=6"
  fi
}

# - —Å—Ä–µ–¥–∞ —Ä–∞–±–æ—Ç—ã –û–° (–∑–∞–ø—Ä–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä –¥–æ–∫–µ—Ä)
check_container() {
  if systemd-detect-virt -cq 2>/dev/null; then
    exiterr "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–Ω—É—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–∞–Ω–Ω—ã–º —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–æ–º."
  fi
}

## –§—É–Ω—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:
# - –ø–æ—Ä—Ç
check_port() {
  # –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ—Ä—Ç —á–∏—Å–ª–æ–º
  if ! [[ "$1" =~ ^[0-9]+$ ]]; then
    echoerr "–ü–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º"
    return 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –ø–æ—Ä—Ç–∞ (49152‚Äì65534)
  if [ "$1" -lt 49152 ] || [ "$1" -gt 65535 ]; then
    echoerr "–ü–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –æ—Ç 49152 –¥–æ 65535"
    return 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–Ω—è—Ç –ª–∏ –ø–æ—Ä—Ç
  if lsof -i :"$1" >/dev/null ; then
    echoerr "–ü–æ—Ä—Ç $1 —É–∂–µ –∑–∞–Ω—è—Ç"
    return 1
  fi

  return 0
}

# - IPv4 –∞–¥—Ä–µ—Å
check_IPv4() {
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–æ—Ä–º–∞—Ç IPv4
  if [[ ! "$1" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
    echoerr "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç IPv4: $1"
    return 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–∫—Ç–µ—Ç–∞ IP
  IFS='.' read -r -a octets <<< "$1"
  for octet in "${octets[@]}"; do
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 01, 001)
    if [[ "$octet" != "0" && "$octet" =~ ^0 ]]; then
      echoerr "–û–∫—Ç–µ—Ç IPv4 —Å –≤–µ–¥—É—â–∏–º –Ω—É–ª—ë–º –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º: $octet"
      return 1
    fi

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —è–≤–Ω–æ –≤ –¥–µ—Å—è—Ç–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∏–º –¥–∏–∞–ø–∞–∑–æ–Ω
    dec_octet=$((10#$octet))
    if ((dec_octet < 0 || dec_octet > 255)); then
      echoerr "–ù–µ–≤–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –æ–∫—Ç–µ—Ç–∞ IPv4: $octet"
      return 1
    fi
  done

  return 0
}

# –§—É–Ω–∫—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è
show_spinner() {
  local pid=$1
  local delay=0.1
  local spinner="|/-\\"
  tput civis  # —Å–∫—Ä—ã—Ç—å –∫—É—Ä—Å–æ—Ä

  while kill -0 "$pid" 2>/dev/null; do
    for i in $(seq 0 3); do
      printf "\r[%c] –í—ã–ø–æ–ª–Ω—è–µ–º, –æ–∂–∏–¥–∞–π—Ç–µ..." "${spinner:$i:1}"
      sleep "$delay"
    done
  done

  wait "$pid"
  local status=$?
  tput cnorm  # –≤–µ—Ä–Ω—É—Ç—å –∫—É—Ä—Å–æ—Ä
  echo
  return $status
}

# –§—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ apt/dpkg
wait_for_apt_unlock() {
  local timeout=300
  local waited=0

  while pgrep -x apt >/dev/null || pgrep -x apt-get >/dev/null || pgrep -x dpkg >/dev/null; do
    sleep 1
    [ "$waited" = 0 ] && echomsg "–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ apt/dpkg..." 1
    ((waited++))
    if (( waited >= timeout )); then
      exiterr "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è ($timeout —Å–µ–∫)."
      return 1
    fi
  done
}

install_pkgs(){
  wait_for_apt_unlock

  echomsg "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π" 1
  (
    (
      apt-get -yqq update > /dev/null 2>&1 || apt-get -yqq update
    ) > /dev/null 2>&1 || exiterr "'apt-get update' –æ—à–∏–±–∫–∞."
    (
      apt-get -yqq upgrade > /dev/null 2>&1 || apt-get -yqq upgrade
    ) > /dev/null 2>&1 || exiterr "'apt-get upgrade' –æ—à–∏–±–∫–∞."
    (
      apt-get -yqq install iproute2 iptables curl tar xz-utils lsof dnsutils grep nano htop \
      || apt-get -yqq install iproute2 iptables curl tar xz-utils lsof dnsutils grep nano htop
    ) > /dev/null 2>&1 || exiterr "'apt-get install' –æ—à–∏–±–∫–∞."
  ) & show_spinner $!

  echook "–ü–∞–∫–µ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}

download_shadowsocks_rust(){
  echomsg "–ó–∞–≥—Ä—É–∑–∫–∞ shadowsocks-rust $version" 1

  mkdir -p "$path_shadowsocks_rust"

  (
    set -e
    curl -fsSLO -H "Cache-Control: no-cache" -H "Pragma: no-cache" \
      "https://github.com/shadowsocks/shadowsocks-rust/releases/download/${version}/shadowsocks-${version}.x86_64-unknown-linux-gnu.tar.xz" && \
    tar -xf "shadowsocks-${version}.x86_64-unknown-linux-gnu.tar.xz" -C "$path_shadowsocks_rust/" && \
    rm -r "shadowsocks-${version}.x86_64-unknown-linux-gnu.tar.xz"
  ) > /dev/null 2>&1 || exiterr "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ shadowsocks-rust"

  echook "shadowsocks-rust $version –∑–∞–≥—Ä—É–∂–µ–Ω"
}

create_sysctl_config (){
  echomsg "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ sysctl –ø–æ –ø—É—Ç–∏ $path_sysctl_config" 1

  # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ—Ç
  mkdir -p "$(dirname "$path_sysctl_config")"

  # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥
  link_sysctl_config="https://raw.githubusercontent.com/jinndi/wg-easy-breezy/main/sysctl.conf"
  curl -fsSL -H "Cache-Control: no-cache" -H "Pragma: no-cache" "$link_sysctl_config" \
      -o "$path_sysctl_config" > /dev/null 2>&1 || exiterr "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ sysctl –∫–æ–Ω—Ñ–∏–≥–∞"

  # –í–∫–ª—é—á–µ–Ω–∏–µ TCP BBR –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏, –µ—Å–ª–∏ –Ω–µ —É–¥–∞—á–Ω–æ, —Ç–æ –ø—Ä–æ–±—É–µ–º hybla
  if modprobe -q tcp_bbr && [ -f /proc/sys/net/ipv4/tcp_congestion_control ]
  then
    echo "net.core.default_qdisc = fq" >> "$path_sysctl_config"
    echo "net.ipv4.tcp_congestion_control = bbr" >> "$path_sysctl_config"
  else
    if modprobe -q tcp_hybla && [ -f /proc/sys/net/ipv4/tcp_congestion_control ]
    then
      echo "net.ipv4.tcp_congestion_control = hybla" >> "$path_sysctl_config"
    fi
  fi

  # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
  sysctl -e -q -p "$path_sysctl_config"

  echook "–ö–æ–Ω—Ñ–∏–≥ sysctl —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω"
}

input_port(){
  while true; do
    echomsg "–í–≤–µ–¥–∏—Ç–µ –ø–æ—Ä—Ç shadowsocks (–æ—Ç 49152 –¥–æ 65535)" 1
    read -rp " > " port
    if check_port "$port"; then
      echook "–ü–æ—Ä—Ç $port –ø—Ä–∏–Ω—è—Ç"
      break
    fi
  done
}

create_config() {
  echomsg "–§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥ shadowsocks-rust —Å–µ—Ä–≤–µ—Ä–∞" 1

  mkdir -p "$(dirname "$path_config")"

  password=$($path_ssservice genkey -m "$encrypt_method")

  {
    echo "{"
    echo "  \"server\": \"::\","
    echo "  \"server_port\": $port,"
    echo "  \"mode\": \"tcp_only\","
    echo "  \"method\": \"$encrypt_method\","
    echo "  \"password\": \"$password\","
    echo "  \"keep_alive\": 25,"
    echo "  \"timeout\": 300,"
    echo "  \"nofile\": 51200,"
    echo "  \"fast_open\": true,"
    echo "  \"no_delay\": true"
    echo "}"
  } > "$path_config"

  # IP —Ç–µ–∫—É—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
  local public_ip

  # ip route (–ª–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
  public_ip=$(ip route get 1.1.1.1 2>/dev/null | awk '{for(i=1;i<=NF;i++) if ($i=="src") print $(i+1)}')

  # —á–µ—Ä–µ–∑ DNS (OpenDNS)
  [ -z "$public_ip" ] && command -v dig >/dev/null && \
    public_ip=$(dig +short -4 myip.opendns.com @resolver1.opendns.com)

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
  if [[ ! "$public_ip" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
    public_ip=""
    echoerr "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π IP"
    while true; do
      echomsg "–í–≤–µ–¥–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π IPv4 –∞—Ä–¥–µ—Å —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞" 1
      read -rp " > " public_ip

      if check_IPv4 "$public_ip"; then
        break
      fi
    done
  fi

  {
    echo "{"
    echo "  \"server\": \"$public_ip\","
    echo "  \"server_port\": $port,"
    echo "  \"method\": \"$encrypt_method\","
    echo "  \"password\": \"$password\""
    echo "}"
  } > "$path_client_for_url_config"

  echook "–ö–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω"
}

create_service(){
  echomsg "–°–æ–∑–¥–∞—ë–º systemd —Å–ª—É–∂–±—É" 1

  # –ü—É—Ç—å –∫ iptables
  local iptables_path
  iptables_path=$(command -v iptables)
  if [[ $(systemd-detect-virt) == "openvz" ]] && \
    readlink -f "$(command -v iptables)" | grep -q "nft" && \
    hash iptables-legacy 2>/dev/null
  then
    iptables_path=$(command -v iptables-legacy)
  fi

  {
    echo "[Unit]"
    echo "Description=Shadowsocks-rust ssserver"
    echo "Documentation=https://github.com/shadowsocks/shadowsocks/wiki"
    echo "After=network.target"
    echo "Wants=network.target"
    echo
    echo "[Service]"
    echo "PermissionsStartOnly=true"
    echo "ExecStartPre=${iptables_path} -I INPUT -p tcp --dport ${port} -j ACCEPT"
    echo "ExecStart=${path_ssserver} -c ${path_config}"
    echo "ExecStopPost=${iptables_path} -D INPUT -p tcp --dport ${port} -j ACCEPT"
    echo "Restart=on-failure"
    echo "User=shadowsocks"
    echo "LimitNOFILE=51200"
    echo "CapabilityBoundingSet=CAP_NET_BIND_SERVICE"
    echo "AmbientCapabilities=CAP_NET_BIND_SERVICE"
    echo "NoNewPrivileges=true"
    echo
    echo "[Install]"
    echo "WantedBy=multi-user.target"
  } > "$path_service"

  echook "–°–ª—É–∂–±–∞ —Å–æ–∑–¥–∞–Ω–∞"
}

add_user(){
  echomsg "–î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'shadowsocks' –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞" 1
  useradd --system --home-dir /nonexistent --no-create-home \
  --shell /usr/sbin/nologin shadowsocks >/dev/null 2>&1 \
  || exiterr "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
  echook "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω"
}

activate_ssserver(){
  echomsg "–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º ssserver —Å–ª—É–∂–±—É" 1
  systemctl daemon-reload >/dev/null 2>&1
  systemctl enable --now ssserver >/dev/null 2>&1
  if systemctl is-active --quiet ssserver; then
    echook "shadowsocks-rust —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω!"
  else
    echoerr "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ shadowsocks-rust!"
  fi
}

press_any_side_to_open_menu() {
  echomsg "\n------------------------------------------------"
  read -n1 -r -p "–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é..."
  select_menu_option
}

switch_active_service(){
  systemctl daemon-reload >/dev/null 2>&1
  if systemctl is-active --quiet ssserver; then
    echomsg "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É–∂–±—É" 1
    { systemctl stop ssserver && systemctl disable ssserver; } >/dev/null 2>&1
    if systemctl is-active --quiet ssserver; then
      echoerr "–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏!"
    else
      echook "–°–ª—É–∂–±–∞ —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
    fi
  else
    echomsg "–ó–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–±—É" 1
    systemctl enable --now ssserver >/dev/null 2>&1
    if systemctl is-active --quiet ssserver; then
      echook "–°–ª—É–∂–±–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞!"
    else
      echoerr "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞!"
    fi
  fi
  press_any_side_to_open_menu
}

reload_service(){
  echomsg "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–±—É" 1
  systemctl daemon-reload >/dev/null 2>&1
  systemctl reload ssserver >/dev/null 2>&1
  if systemctl is-active --quiet ssserver; then
    echook "–°–ª—É–∂–±–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞!"
  else
    echoerr "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞!"
  fi
  press_any_side_to_open_menu
}

show_connect_link() {
  echo -e "\n–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
  echo -e "\033[0;36m$("$path_ssurl" --encode "$path_client_for_url_config")\033[0m"
  press_any_side_to_open_menu
}

show_systemctl_status() {
  systemctl status ssserver --no-pager -l
  press_any_side_to_open_menu
}

show_journalctl_log() {
  journalctl -u ssserver -n 50 --no-pager
  press_any_side_to_open_menu
}

remove_shadowsocks_rust(){
  echo
  read -rp "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ [y/N]: " remove
  until [[ "$remove" =~ ^[yYnN–¥–î–Ω–ù]*$ ]]; do
    echo "–ù–µ–≤–µ—Ä–Ω–∞—è –æ–ø—Ü–∏—è"
    read -rp "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ [y/N]: " remove
  done

  if [[ "$remove" =~ ^[yY–¥–î]$ ]]; then
    echomsg "–£–¥–∞–ª–µ–Ω–∏–µ shadowsocks-rust —Ñ–∞–π–ª–æ–≤" 1
    systemctl stop ssserver >/dev/null 2>&1
    systemctl disable ssserver >/dev/null 2>&1
    rm -f "$path_config"
    rm -f "$path_service"
    rm -f "$path_sysctl_config" 
    rm -f "$path_script"
    rm -f "$path_script_link" 
    rm -rf "$path_shadowsocks_rust"
    systemctl daemon-reload
    userdel shadowsocks
    echook "shadowsocks-rust —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ —Å–∏—Å—Ç–µ–º—ã!"
    exit 0
  else
    select_menu_option
  fi
}

install_ssserver(){
  install_pkgs
  input_port
  download_shadowsocks_rust
  create_config
  create_service
  add_user
  create_sysctl_config
  activate_ssserver

  # –ø–µ—Ä–µ–º–µ—â–∞–º —Ç–µ–∫—É—â–∏–π —Å–∫—Ä–∏–ø—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –Ω–µ–≥–æ –ø—Ä–∞–≤–∞ –∏ —Å—Å—ã–ª–∫—É
  mv "$(realpath "$0")" "$path_script"
  chmod +x "$path_script"
  ln -s "$path_script" "$path_script_link"

  echo
  echo -e "\033[1;32müéâ shadowsocks-rust —Å–µ—Ä–≤–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!\033[0m"
  show_connect_link
}

select_menu_option() {
  clear
  local menu
  local select_option="–ú–µ–Ω—é –æ–ø—Ü–∏–π:"

  show_header
  if systemctl is-active --quiet ssserver; then
    menu+="shadowsocks-rust server $version\n"
    menu+="üü¢ –°–ª—É–∂–±–∞ –∞–∫—Ç–∏–≤–Ω–∞\n"
    menu+="\n$select_option\n"
    menu+=" 1) ‚ùå –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å\n"
  else
    menu+="üî¥ –°–ª—É–∂–±–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞\n"
    menu+="\n$select_option\n"
    menu+=" 1) üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å\n"
  fi

  menu+=" 2) üåÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å\n"
  menu+=" 3) üßø –°—Ç–∞—Ç—É—Å —Å–ª—É–∂–±—ã\n"
  menu+=" 4) üîó –°—Å—ã–ª–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è\n"
  menu+=" 5) üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏\n"
  menu+=" 6) ü™£ –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n"
  menu+=" 7) üö™ –í—ã—Ö–æ–¥ –∏–∑ –º–µ–Ω—é (Ctrl+C)"

  echo -e "$menu"

  read -rp "–û–ø—Ü–∏—è: " option
  until [[ "$option" =~ ^[1-7]$ ]]; do
    echoerr "–ù–µ–≤–µ—Ä–Ω–∞—è –æ–ø—Ü–∏—è"
    read -rp "–û–ø—Ü–∏—è: " option
  done

  [[ "$option" =~ ^[1-7]$ ]] && clear

  case "$option" in
    1)
      switch_active_service
    ;;
    2)
      reload_service
    ;;
    3)
      show_systemctl_status
    ;;
    4)
      show_connect_link
    ;;
    5)
      show_journalctl_log
    ;;
    6)
      remove_shadowsocks_rust
    ;;
    7)
      exit 0
    ;;
  esac
}

if [[ -f "$path_ssserver" && -f "$path_service" ]]; then
  select_menu_option
else
  clear
  check_root
  check_shell
  check_kernel
  check_os
  check_os_ver
  check_container
  show_header
  read -n1 -r -p "–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É..."
  install_ssserver
fi
