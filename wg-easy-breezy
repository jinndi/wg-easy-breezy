#!/bin/bash
#
# https://github.com/jinndi/wg-easy-breezy
#
# Copyright (c) 2025 Jinndi <alncores@gmail.ru>
#
# Released under the MIT License, see the accompanying file LICENSE
# or https://opensource.org/licenses/MIT

## –ù–µ–∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏ APT
export DEBIAN_FRONTEND=noninteractive
export DEBCONF_NONINTERACTIVE_SEEN=true

## –ü—É—Ç–∏ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

## –ü—É—Ç–∏ —Ñ–∞–π–ª–æ–≤:
# - –ø–∞–ø–∫–∞ –≤ –∫–æ—Ç–æ—Ä—É—é –±—É–¥–µ—Ç –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞
path_data_dir="/opt/wg-easy-breezy"
# - —Ñ–∞–π–ª —Ç–µ–∫—É—â–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
path_script="$path_data_dir/wg-easy-breezy"
# - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª —Ç–µ–∫—É—â–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
path_script_link="/usr/bin/wgeb"
# - —Ñ–∞–π–ª Dockerfile —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞ wg-easy-breezy
path_dockerfile="$path_data_dir/Dockerfile"
# - —Ñ–∞–π–ª start.sh –¥–ª—è –¥–æ–∫–µ—Ä image wg-easy-breezy
path_start_sh="$path_data_dir/start.sh"
# - —Ñ–∞–π–ª docker compose (podman-compose) –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
path_docker_compose_file="$path_data_dir/services.yml"
# - —Ñ–∞–π–ª –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è .env
path_env_file="$path_data_dir/.env"
# - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª systemd unit —Å–ª—É–∂–±—ã
path_systemd_unit_file="/etc/systemd/system/wg-easy-breezy.service"
# - —Ñ–∞–π–ª –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Caddy —Å–µ—Ä–≤–µ—Ä–∞
path_caddyfile="$path_data_dir/Caddyfile"
# - —Ñ–∞–π–ª —Å–∫—Ä–∏–ø—Ç–∞ c —Å–µ—Ç–µ–≤—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ iptables –Ω–∞ –∑–∞–ø—É—Å–∫ wg-easy-breezy
path_iptables_apply_script="$path_data_dir/iptables/apply.sh"
# - —Ñ–∞–π–ª —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞–Ω–µ–µ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö iptables –ø—Ä–∞–≤–∏–ª
path_iptables_delete_script="$path_data_dir/iptables/delete.sh"
# - —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥–∞ sysctl –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
path_sysctl_config="$path_data_dir/sysctl.conf"
# - —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥–∞ sysctl (path_sysctl_config)
path_sysctl_config_link="/etc/sysctl.d/99-wg-easy-breezy.conf"

# –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—Ä–∞–∑ wg-easy
wg_easy_image="ghcr.io/wg-easy/wg-easy:14"
 
# –ü—Ä–µ—Ñ–∏–∫—Å –∫ –∏–º–µ–Ω–∞–º podman —Å–µ—Ä–≤–∏—Å–æ–≤, —Å–µ—Ç–∏, —Ç–æ–º–æ–≤, url –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
service_prefix="wgeb"

## –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–≤–∞–µ–º—ã—Ö –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞:
# - —è—Ä–ª—ã–∫ –∏–º–µ–Ω–∏ —Å–ª—É–∂–±—ã, —Å–µ—Ç–∏, —Ç–æ–º–æ–≤, url –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
service_tag=""
# - –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è –ª–∏–±–æ IP-–∞–¥—Ä–µ—Å —Ö–æ—Å—Ç–∞
host=""
# - e-mail –∞–¥—Ä–µ—Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–æ–º–µ–Ω–∞
email=""
# - —Å—Å—ã–ª–∫–∞ (SIP002 URI scheme) –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ shadowsocks —Å–µ—Ä–≤–µ—Ä—É
ss_link=""
# - tcp –ø–æ—Ä—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ UI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É wg-easy
port_ui=""
# - udp –ø–æ—Ä—Ç WireGuard
port_wg=""
# - –¥–∏–∞–ø–∞–∑–æ–Ω IP-–∞–¥—Ä–µ—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤ WireGuard
address=""
# - —Å—Å—ã–ª–∫–∞ –Ω–∞ UI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å wg-easy
link_ui=""
# - —É–∫–∞–∑–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥—Ä–µ—Å –¥–æ–º–µ–Ω–∞
is_domain=""
# - —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏
# -- main - wg-easy –±–∞–∑–æ–≤—ã–π
# -- proxy - wg-easy -> –ø—Ä–æ–∫—Å–∏ shasowsocks
install_mode=""

## –§—É–Ω–∫—Ü–∏–∏ –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:
# - —à–∞–ø–∫–∞ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞
show_header() {
echo -e "\033[1;35m"
cat <<EOF
###################################################
#                  WG-EASY-BREEZY                 #
# GitHub:https://github.com/jinndi/wg-easy-breezy #
###################################################
EOF
echo -e "\033[0m"
}
# - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ
echomsg() {
  if [ -n "$2" ]; then
    echo
  fi
  echo -e "\033[1;34m$1\033[0m"
}
# - –æ–± —É—Å–ø–µ—Ö–µ
echook() {
  echo -e "\033[1;32m$1\033[0m"
}
# - –æ–± –æ—à–∏–±–∫–µ
echoerr () {
  echo -e "\033[1;31m$1\033[0m"
}
# - –æ–± –æ—à–∏–±–∫–µ —Å –≤—ã—Ö–æ–¥–æ–º –∏–∑ —Å–∫—Ä–∏–ø—Ç–∞
exiterr() {
  echo -e "\033[1;31m –û—à–∏–±–∫–∞: $1\033[0m" >&2
  exit 1
}


## –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
# - —Ä—É—Ç –ø—Ä–∞–≤–∞
check_root() {
  if [ "$(id -u)" != 0 ]; then
    exiterr "–≠—Ç–æ—Ç —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç –∏–º–µ–Ω–∏ root. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ 'sudo bash $0'"
  fi
}

# - —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞ —Å–∫—Ä–∏–ø—Ç–∞ —á–µ—Ä–µ–∑ bash –∞ –Ω–µ sh
check_shell() {
  if readlink /proc/$$/exe | grep -q "dash"; then
    exiterr '–≠—Ç–æ—Ç —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞–ø—É—Å–∫–∞—Ç—å —Å –ø–æ–º–æ—â—å—é ¬´bash¬ª, –∞ –Ω–µ ¬´sh¬ª.'
  fi
}

# - –≤–∏–¥ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞ –û–°
check_os() {
  if grep -qs "ubuntu" /etc/os-release; then
    os="ubuntu"
    os_version=$(grep 'VERSION_ID' /etc/os-release | cut -d '"' -f 2 | tr -d '.')
  elif [[ -e /etc/debian_version ]]; then
    os="debian"
    os_version=$(grep -oE '[0-9]+' /etc/debian_version | head -1)
  else
    exiterr "–≠—Ç–æ—Ç —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤—ã Ubuntu –∏ Debian!"
  fi
}

# - –≤–µ—Ä—Å–∏—è –¥–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤–∞ –û–°
check_os_ver() {
  if [[ "$os" == "ubuntu" && "$os_version" -lt 2404 ]]; then
    exiterr "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è Ubuntu 24.04 –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω—è—è –≤–µ—Ä—Å–∏—è."
  fi
  if [[ "$os" == "debian" && "$os_version" -lt 12 ]]; then
    exiterr "–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç—Å—è Debian 12 –∏–ª–∏ –±–æ–ª–µ–µ –ø–æ–∑–¥–Ω—è—è –≤–µ—Ä—Å–∏—è."
  fi
}

# - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –≤–µ—Ä—Å–∏–∏ —è–¥—Ä–∞
check_kernel() {
  if [[ $(uname -r | cut -d "." -f 1) -lt 6 ]]; then
     exiterr "–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —è–¥—Ä–æ –û–° –≤–µ—Ä—Å–∏–∏ >=6"
  fi
}

# - —Å—Ä–µ–¥–∞ —Ä–∞–±–æ—Ç—ã –û–° (–∑–∞–ø—Ä–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä –¥–æ–∫–µ—Ä)
check_container() {
  if systemd-detect-virt -cq 2>/dev/null; then
    exiterr "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–Ω—É—Ç–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–∞–Ω–Ω—ã–º —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–æ–º."
  fi
}
    
# –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —É—Å—Ç–∞–Ω–æ–≤–æ–∫ (–±–µ–∑ –¥–æ–∫–µ—Ä–∞)
remove_install() {
  local is_show_info
  is_show_info="$1"

  if [[ -n "$is_show_info" ]]; then
    echomsg "–£–¥–∞–ª—è–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É" 1
  fi

  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
  systemctl disable --now wg-easy-breezy > /dev/null 2>&1
  if [[ -e "$path_docker_compose_file" ]]; then
    podman-compose -f $path_docker_compose_file down -t 5 > /dev/null 2>&1
  fi

  # –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤
  podman rmi wg-easy-breezy > /dev/null 2>&1
  podman rmi "$wg_easy_image" > /dev/null 2>&1

  # –î–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è —Ä–∞–Ω–µ–µ –∑–∞–¥–∞–Ω–Ω—ã—Ö iptables –ø—Ä–∞–≤–∏–ª 
  if [[ -f "$path_iptables_delete_script" ]]; then
    bash "$path_iptables_delete_script"
  fi

  # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  if [[ -L "$path_script_link" ]]; then
    rm -f "$path_script_link"
  fi

  # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ sysctl –∫–æ–Ω—Ñ–∏–≥ —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π
  if [[ -L "$path_sysctl_config_link" ]]; then
    rm -f "$path_sysctl_config_link"
    sysctl --system > /dev/null 2>&1
  fi
  
  # –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏ –¥–∞–Ω–Ω—ã—Ö
  if [[ -d "$path_data_dir" ]]; then
    rm -rf "$path_data_dir"
  fi

  # –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ systemd —Å–ª—É–∂–±—ã
  if [[ -f "$path_systemd_unit_file" ]]; then
    rm -f "$path_systemd_unit_file"
    systemctl daemon-reload
  fi

  if [[ -n "$is_show_info" ]]; then
    echook "–§–∞–π–ª—ã –∏ —Å–ª—É–∂–±—ã/—Å–µ—Ä–≤–∏—Å—ã —É–¥–∞–ª–µ–Ω—ã"
  fi
}

# –§—É–Ω–∫—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è
show_spinner() {
  local pid=$1
  local delay=0.1
  local spinner="|/-\\"
  tput civis  # —Å–∫—Ä—ã—Ç—å –∫—É—Ä—Å–æ—Ä

  while kill -0 "$pid" 2>/dev/null; do
    for i in $(seq 0 3); do
      printf "\r[%c] –í—ã–ø–æ–ª–Ω—è–µ–º, –æ–∂–∏–¥–∞–π—Ç–µ..." "${spinner:$i:1}"
      sleep "$delay"
    done
  done

  wait "$pid"
  local status=$?
  tput cnorm  # –≤–µ—Ä–Ω—É—Ç—å –∫—É—Ä—Å–æ—Ä
  echo
  return $status
}


# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º
install_pkgs() {
  # –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ–∫–∞ —Å–∏—Å—Ç–µ–º–∞ –æ—Å–≤–æ–±–æ–¥–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –ø–∞–∫–µ—Ç–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (apt/dpkg)
  local count apt_lk apt_lk frontend_lk has_fuser has_lsof yq_path
  count=0
  apt_lk="/var/lib/apt/lists/lock"
  pkg_lk="/var/lib/dpkg/lock"
  frontend_lk="/var/lib/dpkg/lock-frontend"
  has_fuser=$(command -v fuser)
  has_lsof=$(command -v lsof)

  while \
    { [ "$has_fuser" ] && { fuser "$apt_lk" "$pkg_lk" "$frontend_lk" >/dev/null 2>&1; }; } || \
    { [ "$has_lsof" ] && { lsof "$apt_lk" >/dev/null 2>&1 || lsof "$pkg_lk" >/dev/null 2>&1 || \
    lsof "$frontend_lk" >/dev/null 2>&1; }; }
  do
    [ "$count" = 0 ] && echo "–û–∂–∏–¥–∞–µ–º, –∫–æ–≥–¥–∞ apt –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è..."
    [ "$count" -ge 100 ] && exiterr "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–∂–¥–∞—Ç—å—Å—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É apt/dpkg."
    count=$((count+1))
    printf '%s' '.'
    sleep 3
  done

  echomsg "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π" 1
  (
    (
      apt-get -yqq update > /dev/null 2>&1 || apt-get -yqq update > /dev/null 2>&1
    ) || exiterr "'apt-get update' –æ—à–∏–±–∫–∞."
    (
      apt-get -yqq upgrade > /dev/null 2>&1 || apt-get -yqq upgrade > /dev/null 2>&1
    ) || exiterr "'apt-get upgrade' –æ—à–∏–±–∫–∞."
    (
      apt-get -yqq install podman podman-compose iproute2 iptables openssl lsof \
        dnsutils curl idn grep sed nano htop > /dev/null 2>&1 \
      || apt-get -yqq install podman podman-compose iproute2 iptables openssl lsof \
        dnsutils curl idn grep sed nano htop > /dev/null 2>&1
    ) || exiterr "'apt-get install' –æ—à–∏–±–∫–∞."

    # mikefarah yq
    yq_path=$(command -v yq)
    if [[ -n "$yq_path" ]]; then
      if ! yq --version 2>/dev/null | grep -q 'mikefarah'; then
        rm -f "$yq_path"
        hash -r 2>/dev/null
      fi
    fi
    if ! command -v yq >/dev/null; then
      curl -fsSL -H "Cache-Control: no-cache" -H "Pragma: no-cache" \
        https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 \
        -o /usr/local/bin/yq || {
        exiterr "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å mikefarah/yq"
      }
      chmod +x /usr/local/bin/yq
    fi

    # –°–ø—É–ª–ª–∏—Ç—å –æ–±—Ä–∞–∑ wg-easy
    podman pull "$wg_easy_image" > /dev/null 2>&1 || exiterr "–æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ $wg_easy_image"

  ) & show_spinner $!

  echook "–ü–∞–∫–µ—Ç—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
}


## –§—É–Ω—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–æ–∫ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:

# - —Ç–µ–≥
check_tag() {
  local tag="$1"
  local service_name="${service_prefix}-${tag}"

  # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω–∏—Ü—É, —Ü–∏—Ñ—Ä—ã, —Ç–∏—Ä–µ (-)
  if [[ ! "$tag" =~ ^[A-Za-z0-9-]{1,16}$ ]]; then
    echoerr "–û—à–∏–±–∫–∞: '$tag' –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º"
    return 1
  fi

  if [[ -f "$path_docker_compose_file" ]] && \
    [[ "$(yq e ".services.\"$service_name\"" "$path_docker_compose_file")" != "null" ]]
  then
    echoerr "–û—à–∏–±–∫–∞: –°–µ—Ä–≤–∏—Å –ø–æ–¥ —Ç–µ–≥–æ–º '$tag' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    return 1
  fi

  return 0
}

# - –∏–º—è –¥–æ–º–µ–Ω–∞
check_domain() {
  # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–æ–º–µ–Ω–æ–º
  if [[ ! "$1" =~ ^([a-z0-9]([a-z0-9-]*[a-z0-9])?\.)+[a-z]{2,}$ ]]; then
    echoerr "–ù–µ–∫–∫–æ—Ä–µ–∫—Ç–Ω—ã–π –∞–¥—Ä–µ—Å –¥–æ–º–µ–Ω–∞: $1"
    is_domain=""
    return 1
  fi
  is_domain="true"
  return 0
}

# - IPv4 –∞–¥—Ä–µ—Å
check_IPv4() {
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–æ—Ä–º–∞—Ç IPv4
  if [[ ! "$1" =~ ^([0-9]{1,3}\.){3}[0-9]{1,3}$ ]]; then
    echoerr "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç IPv4: $1"
    return 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ–∫—Ç–µ—Ç–∞ IP
  IFS='.' read -r -a octets <<< "$1"
  for octet in "${octets[@]}"; do
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–µ–¥—É—â–∏–µ –Ω—É–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 01, 001)
    if [[ "$octet" != "0" && "$octet" =~ ^0 ]]; then
      echoerr "–û–∫—Ç–µ—Ç IPv4 —Å –≤–µ–¥—É—â–∏–º –Ω—É–ª—ë–º –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º: $octet"
      return 1
    fi

    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —è–≤–Ω–æ –≤ –¥–µ—Å—è—Ç–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∏–º –¥–∏–∞–ø–∞–∑–æ–Ω
    dec_octet=$((10#$octet))
    if ((dec_octet < 0 || dec_octet > 255)); then
      echoerr "–ù–µ–≤–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –æ–∫—Ç–µ—Ç–∞ IPv4: $octet"
      return 1
    fi
  done

  return 0
}

# - e-mail –∞–¥—Ä–µ—Å
check_email() {
  # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –¥–æ–º–µ–Ω–æ–º
  if [[ ! "$1" =~ ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$ ]]; then
    echoerr "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email: $1"
    return 1
  fi

  return 0
}

# - –ø–∞—Ä–æ–ª—å
check_password() {
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –≤–≤–æ–¥
  if [ -z "$1" ]; then
    echoerr "–ü–∞—Ä–æ–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
    return 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –ø–∞—Ä–æ–ª—è (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)
  if [ "${#1}" -lt 6 ]; then
    echoerr "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –∫–æ—Ä–æ—á–µ 6 —Å–∏–º–≤–æ–ª–æ–≤"
    return 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π –±—É–∫–≤—ã
  if ! echo "$1" | grep -q '[a-zA-Z]'; then
    echoerr "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –±—É–∫–≤—É"
    return 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–π —Ü–∏—Ñ—Ä—ã
  if ! echo "$1" | grep -q '[0-9]'; then
    echoerr "–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É"
    return 1
  fi

  return 0
}

# - –ø–æ—Ä—Ç
check_port() {
  local port="$1"

  # –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ—Ä—Ç —á–∏—Å–ª–æ–º
  if ! [[ "$port" =~ ^[0-9]+$ ]]; then
    echoerr "–ü–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º"
    return 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –ø–æ—Ä—Ç–∞ (49152‚Äì65534)
  if [ "$port" -lt 49152 ] || [ "$port" -gt 65534 ]; then
    echoerr "–ü–æ—Ä—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –æ—Ç 49152 –¥–æ 65534"
    return 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞, –∑–∞–Ω—è—Ç –ª–∏ –ø–æ—Ä—Ç –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç
  if lsof -i :"$port" >/dev/null ; then
    echoerr "–ü–æ—Ä—Ç '$port' –∑–∞–Ω—è—Ç"
    return 1
  fi

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω –ª–∏ –ø–æ—Ä—Ç —É–∂–µ –≤ services.yml
  if [[ -f "$path_docker_compose_file" ]]; then
    yq -r '.services | keys[]' "$path_docker_compose_file" | while read -r service; do
      if [[ "$service" == "${service_prefix}-"* ]]; then
        local wg_port ui_port
        port_wg=$(get_env_var_from_service "$service" "WG_PORT" "")
        port_ui=$(get_env_var_from_service "$service" "PORT" "")
        if [[ "$port" == "$port_wg" ]] || [[ "$port" == "$port_ui" ]]; then
          echoerr "–ü–æ—Ä—Ç '$port' —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω –≤ —Å–µ—Ä–≤–∏—Å–µ $service"
          return 1
        fi
      fi
    done
  fi

  return 0
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏ IP —Å–µ—Ä–≤–µ—Ä–∞
get_public_ip() {
  local public_ip

  # ip route (–ª–æ–∫–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
  public_ip=$(ip route get 1.1.1.1 2>/dev/null | awk '{for(i=1;i<=NF;i++) if ($i=="src") print $(i+1)}')

  # —á–µ—Ä–µ–∑ dig
  [ -z "$public_ip" ] && command -v dig >/dev/null && \
    public_ip=$(dig +short -4 myip.opendns.com @resolver1.opendns.com)

  # –ß–µ—Ä–µ–∑ curl
  [ -z "$public_ip" ] && command -v curl >/dev/null && \
    public_ip=$(curl -s https://api.ipify.org)

  # –ü—Ä–æ–≤–µ—Ä–∫–∞
  if ! check_IPv4 "$public_ip"; then
    echoerr "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π IP"

    while true; do
      echomsg "–í–≤–µ–¥–∏—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–π IPv4 –∞–¥—Ä–µ—Å —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞"
      read -rp "IPv4 —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞: " public_ip
      if check_IPv4 "$public_ip"; then break; fi
    done
  fi

  echo "$public_ip"
}


## –§—É–Ω–∫—Ü–∏–∏ –≤–≤–æ–¥–∞:

# - —è—Ä–ª—ã–∫ –¥–ª—è –¥–æ–±–∞–≤–ª—è–µ–º–æ–π —Å–ª—É–∂–±—ã (–ø–æ–ª–Ω–æ–µ –∏–º—è service_prefix-service_tag)
input_tag() {
  while true; do
    echomsg "–ö–æ—Ç–æ—Ä–∫–æ–µ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ (tag). –õ–∞—Ç–∏–Ω–∏—Ü–∞, —Ü–∏—Ñ—Ä—ã –∏ —Ç–∏—Ä–µ –¥–æ 16 —Å–∏–º–≤–æ–ª–æ–≤." 1
    echomsg "(–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫ –∏–º–µ–Ω–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Å–µ—Ç–∏, —Ç–æ–º–æ–≤, URL –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)"
    read -rp " > " service_tag
    
    if check_tag "$service_tag"; then
      echook "–¢–µ–≥: $service_tag –ø—Ä–∏–Ω—è—Ç"
      break
    fi
  done
}

# - –∏–º—è –¥–æ–º–µ–Ω–∞ (–ª–∏–±–æ IPv4 –µ—Å–ª–∏ –Ω–µ—Ç)
input_domain() {
  while true; do
    echomsg "–î–æ–º–µ–Ω–Ω–æ–µ –∏–º—è —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä mydomain.com" 1
    echomsg "(–Ω–∞–∂–º–∏—Ç–µ –∫–ª–∞–≤–∏—à—É Enter —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å –ø–æ–∑–∂–µ)"
    read -rp " > " host
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –≤–≤–æ–¥
    if [ -z "$host" ]; then
      host=$(get_public_ip)
      echook "–ò—Å–ø–æ–ª—å–∑—É–µ–º IPv4: $host"
      break
    else
      # –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ punycode (–Ω–∞ —Å–ª—É—á–∞–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã) —Å –Ω–∏–∂–Ω–∏–º —Ä–µ–≥–∏—Å—Ç—Ä–æ–º
      host=$(idn "$host" | tr '[:upper:]' '[:lower:]')
      # –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏
      if check_domain "$host"; then
        echook "–î–æ–º–µ–Ω–Ω–æ–µ –∏–º—è: $host –ø—Ä–∏–Ω—è—Ç–æ"
        break
      fi
    fi
  done

  # –∑–∞–º–µ–Ω—è–µ–º/–¥–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ .env
  if grep -q '^WG_HOST=' "$path_env_file"; then
    sed -i "s/^WG_HOST=.*/WG_HOST=$host/" "$path_env_file"
  else
    echo "WG_HOST=$host" >> "$path_env_file"
  fi
}

# - e-mail –¥–ª—è –ø–æ–ª—É—á–µ–Ω—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ –¥–æ–º–µ–Ω–∞
input_email() {
  [[ "$is_domain" ]] || return

  while true; do
    echomsg "–í–∞—à e-mail –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞" 1
    read -rp " > " email

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞
    if check_email "$email"; then
      echook "E-mail: $email –ø—Ä–∏–Ω—è—Ç"
      break
    fi
  done
}

# - —Å—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ shadowsocks (SIP002 URI scheme)
input_ss_link() {
  [[ "$install_mode" = "main" ]] && return

  local ss_clean base64_part ip_port_part public_ip port decoded password method

  while true; do
    echomsg "–°—Å—ã–ª–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ shadowsocks" 1
    read -rp " > " ss_link
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –≤–≤–æ–¥
    if [ -z "$ss_link" ]; then
      break
    fi

    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å ss://, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    [[ "$ss_link" != ss://* ]] && ss_link="ss://${ss_link}"

    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ—Ñ–∏–∫—Å
    ss_clean="${ss_link#ss://}"

    # –ò–∑–≤–ª–µ–∫–∞–µ–º base64, IP –∏ –ø–æ—Ä—Ç
    base64_part="${ss_clean%@*}"
    ip_port_part="${ss_clean#*@}"
    public_ip="${ip_port_part%%:*}"
    port="${ip_port_part##*:}"

    # –î–µ–∫–æ–¥–∏—Ä—É–µ–º base64 —Å—Ç—Ä–æ–∫—É
    if ! decoded=$(echo "$base64_part" | openssl base64 -d 2>/dev/null); then
      echoerr "–û—à–∏–±–∫–∞: base64 –Ω–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å"
      continue
    fi

    # –ü–æ–ª—É—á–∞–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥ —à–∏—Ñ—Ä–∞ 
    method="${decoded%%:*}"
    case "$method" in
      chacha20-ietf-poly1305|aes-128-gcm|aes-256-gcm)
        # –í—Å—ë –æ–∫
        ;;
      *)
        echoerr "–û—à–∏–±–∫–∞: –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –º–µ—Ç–æ–¥ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è: $method"
        continue
        ;;
    esac

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ IPv4
    if check_IPv4 "$public_ip"; then
      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞
      if ! [[ "$port" =~ ^[0-9]+$ ]] || (( port < 49152 || port > 65535 )); then
        echoerr "–û—à–∏–±–∫–∞: –ø–æ—Ä—Ç $port –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ 49152‚Äì65535"
        continue
      fi

      echook "–°—Å—ã–ª–∫–∞ shadowsocks –ø—Ä–∏–Ω—è—Ç–∞"
      break
    fi
  done
}

# - –ø–æ—Ä—Ç WireGuard —Å–µ—Ä–≤–µ—Ä–∞, –∏ UI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
input_port() {
  while true; do
    echomsg "–ü–æ—Ä—Ç –¥–ª—è WireGuard –æ—Ç 49152 –¥–æ 65534" 1
    echomsg "(–¥–ª—è –≤–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –±—É–¥–µ—Ç —É–≤–µ–ª–∏—á–µ–Ω –Ω–∞ 1)"
    read -rp " > " port_wg

    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ—Ä—Ç –Ω–∞ 1 (–¥–ª—è UI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)
    port_ui=$((port_wg + 1))

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
    if check_port "$port_wg" && check_port "$port_ui"; then
      echook "–ó–∞–¥–∞–Ω—ã –ø–æ—Ä—Ç—ã:"
      echook " - WireGuard: $port_wg"
      echook " - –í–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: $port_ui"
      break
    fi
  done
}

# - –¥–∏–∞–ø–∞–∑–æ–Ω –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤ WireGuard
input_address() {
  local default_value="10.0.0.x"

  while true; do
    echomsg "–î–∏–∞–ø–∞–∑–æ–Ω IP –∞–¥—Ä–µ—Å–æ–≤ –∫–ª–∏–µ–Ω—Ç–æ–≤ WireGuard," 1
    echomsg "–Ω–∞–ø—Ä–∏–º–µ—Ä 10.0.0.x, 10.1.0.x, –∏ —Ç.–ø."
    read -r -e -i "$default_value" address
    address=${address:-$default_value}

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã
    if [[ -f "$path_docker_compose_file" ]]; then
      local conflict=0
      while read -r service; do
        if [[ "$service" == "${service_prefix}-"* ]]; then
          local existing_address
          existing_address=$(get_env_var_from_service "$service" "WG_DEFAULT_ADDRESS" "")
          if [[ "$address" == "$existing_address" ]]; then
            echoerr "–ó–Ω–∞—á–µ–Ω–∏–µ '$address' —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ –≤ —Å–µ—Ä–≤–∏—Å–µ $service"
            conflict=1
            break
          fi
        fi
      done < <(yq -r '.services | keys[]' "$path_docker_compose_file")

      if [[ "$conflict" -eq 1 ]]; then
        continue  # –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—á–∞–ª—É –≤–≤–æ–¥–∞
      fi
    fi

    break  # –∞–¥—Ä–µ—Å —É–Ω–∏–∫–∞–ª–µ–Ω
  done

  echook "–ó–∞–¥–∞–Ω –¥–∏–∞–ø–∞–∑–æ–Ω –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤: $address"
}


# - –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ UI wg-easy
input_password() {
  local output_wgpw password password_hash

  while true; do
    echomsg "–°–ª–æ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å(—ã) (–≤–≤–æ–¥ —Å–∫—Ä—ã—Ç)," 1
    echomsg "—à–µ—Å—Ç—å –∏ –±–æ–ª–µ–µ —Å–∏–º–≤–æ–ª–æ–≤, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–ª–∏—á–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã"
    read -rsp " > " password
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞—Ä–æ–ª—è
    if check_password "$password"; then
      # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ö–µ—à–∞ –ø–∞—Ä–æ–ª—è
      output_wgpw=$(podman run --rm -it $wg_easy_image wgpw "$password")
      # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ö–µ—à –ø–∞—Ä–æ–ª—è
      password_hash=$(echo "$output_wgpw" | cut -d "'" -f2 | sed 's/\$/\$\$/g' | tr -d '\r')
      printf "PASSWORD_HASH='%s'\n" "$password_hash" >> "$path_env_file"
      echo
      echook "–ü–∞—Ä–æ–ª—å –≤–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø—Ä–∏–Ω—è—Ç"
      break
    fi
  done
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ MTU WireGuard
find_optimal_wg_mtu() {
  local target=8.8.8.8
  local low=1300
  local high=1500
  local last_good=0
  local wg_mtu

  echomsg "–ü–æ–∏—Å–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ MTU –¥–ª—è WireGuard..." 1

  while (( low <= high )); do
    local mid=$(((low + high) / 2))
    local size=$((mid - 28))  # 20 –±–∞–π—Ç IP + 8 –±–∞–π—Ç ICMP

    if ping -c1 -W1 -M "do" -s "$size" "$target" &>/dev/null; then
      last_good=$mid
      low=$((mid + 1))
    else
      high=$((mid - 1))
    fi
  done

  if [ "$last_good" -ge 1000 ] 2>/dev/null; then
    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º MTU –¥–ª—è WireGuard
    wg_mtu=$((last_good - 80))
    (( wg_mtu < 1200 )) && wg_mtu=1200

    echook "–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π MTU WireGuard: $wg_mtu"
  else
    wg_mtu=1420
    echoerr "–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º: 1420"
  fi
  echo "WG_MTU=$wg_mtu" >> $path_env_file 
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏ –ø—É—Ç–∏ iptables
get_iptables_path() {
  local path
  path=$(command -v iptables)

  if [[ $(systemd-detect-virt) == "openvz" ]] && \
     readlink -f "$path" | grep -q "nft" && \
     hash iptables-legacy 2>/dev/null; then
    path=$(command -v iptables-legacy)
  fi

  echo "$path"
}

# –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –≤ apply –∏ delete —Å–∫—Ä–∏–ø—Ç—ã iptables –ø–æ port –∏ proto
add_iptables_rule() {
  local port="$1"
  local proto="$2"
  local iptables_path
  iptables_path="$(get_iptables_path)"
  local apply_rule="$iptables_path -w 5 -I INPUT -p $proto --dport $port -j ACCEPT"
  local delete_rule="$iptables_path -w 5 -D INPUT -p $proto --dport $port -j ACCEPT"

  grep -qxF "$apply_rule" "$path_iptables_apply_script" 2>/dev/null || \
    echo "$apply_rule" >> "$path_iptables_apply_script"
  grep -qxF "$delete_rule" "$path_iptables_delete_script" 2>/dev/null || \
    echo "$delete_rule" >> "$path_iptables_delete_script"
}

# –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª –∏–∑ apply –∏ delete —Å–∫—Ä–∏–ø—Ç–æ–≤ iptables –ø–æ port –∏ proto  
remove_iptables_rule() {
  local port="$1"
  local proto="$2"
  local iptables_path
  iptables_path="$(get_iptables_path)"
  local apply_rule="$iptables_path -w 5 -I INPUT -p $proto --dport $port -j ACCEPT"
  local delete_rule="$iptables_path -w 5 -D INPUT -p $proto --dport $port -j ACCEPT"

  sed -i "\|^$apply_rule\$|d" "$path_iptables_apply_script"
  sed -i "\|^$delete_rule\$|d" "$path_iptables_delete_script"
}

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ—Ä—Ç–æ–≤ —á–µ—Ä–µ–∑ iptables, –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ/–æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å–ª—É–∂–±—ã
create_iptables_scripts() {
  echomsg "–°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ—Ä—Ç–æ–≤ —á–µ—Ä–µ–∑ iptables" 1

  # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤ –Ω–∞ –∑–∞–ø—É—Å–∫/–æ—Å—Ç–∞–Ω–æ–≤–∫—É —Å–ª—É–∂–±
  mkdir -p "$(dirname "$path_iptables_apply_script")"
  mkdir -p "$(dirname "$path_iptables_delete_script")"

  # –û—á–∏—Å—Ç–∫–∞/—Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∫–æ–Ω—Ñ–∏–≥–æ–≤
  : > "$path_iptables_apply_script"
  : > "$path_iptables_delete_script"

  # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç—ã —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏:
  {
    echo "#!/bin/bash"
    echo ""
  } | tee "$path_iptables_apply_script" "$path_iptables_delete_script" > /dev/null

  # –ó–∞–ø—Ä–µ—Ç 80/tcp –ø–æ—Ä—Ç–∞
  local iptables_path
  iptables_path="$(get_iptables_path)"
  echo "$iptables_path -w 5 -I INPUT -p tcp --dport 80 -j DROP" >> "$path_iptables_apply_script"
  echo "$iptables_path -w 5 -D INPUT -p tcp --dport 80 -j DROP" >> "$path_iptables_delete_script"

  # –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏
  chmod +x "$path_iptables_apply_script" "$path_iptables_delete_script"

  echook "–°–∫—Ä–∏–ø—Ç—ã —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ iptables —Å–æ–∑–¥–∞–Ω—ã"
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ .env (–µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
load_env() {
  if [ -f "$path_env_file" ]; then
    set -o allexport
    # shellcheck disable=SC1090
    source "$path_env_file"
    set +o allexport
  fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ wg
add_wg_service() {
  local service_name="$service_prefix-$1"
  local port_wg="$2"
  local port_ui="$3"
  local address="${4:-10.8.1.x}"
  local ss_link="${5:-}"

  # –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞
  yq e -i ".services.${service_name} = {
    \"image\": \"wg-easy-breezy\",
    \"container_name\": \"${service_name}\",
    \"environment\": {
      \"LANG\": \"\${LANG}\",
      \"WG_HOST\": \"\${WG_HOST}\",
      \"PASSWORD_HASH\": \"\${PASSWORD_HASH}\",
      \"PORT\": \"${port_ui}\",
      \"WG_PORT\": \"${port_wg}\",
      \"WG_MTU\": \"\${WG_MTU}\",
      \"WG_PERSISTENT_KEEPALIVE\": \"\${WG_PERSISTENT_KEEPALIVE}\",
      \"WG_DEFAULT_ADDRESS\": \"${address}\",
      \"WG_DEFAULT_DNS\": \"\${WG_DEFAULT_DNS}\",
      \"UI_TRAFFIC_STATS\": \"\${UI_TRAFFIC_STATS}\"
    },
    \"volumes\": [
      \"${service_name}:/etc/wireguard\",
      \"/lib/modules:/lib/modules\"
    ],
    \"networks\": [\"${service_prefix}\"],
    \"ports\": [
      \"${port_wg}:${port_wg}/udp\",
      \"${port_ui}:${port_ui}/tcp\"
    ],
    \"privileged\": true,
    \"ulimits\": {
      \"nofile\": {
        \"soft\": 51200,
        \"hard\": 51200
      }
    }
  }" "$path_docker_compose_file"

  # –µ—Å–ª–∏ ss_link –ø–µ—Ä–µ–¥–∞–Ω–∞
  if [ -n "$ss_link" ]; then
    # –¥–æ–±–∞–≤–∏—Ç—å devices
    yq e -i "
      .services.${service_name}.devices = [\"/dev/net/tun\"]
    " "$path_docker_compose_file"

    # –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ environment
    yq e -i ".services.${service_name}.environment += {
        \"WG_DEVICE\": \"sstun\",
        \"SS_TUN_NAME\": \"sstun\",
        \"SS_LINK\": \"${ss_link}\"
      }
    " "$path_docker_compose_file"
  fi

  # volumes –∫–∞–∫ service_name
  yq e -i ".volumes += {
    \"${service_name}\": { \"name\": \"${service_name}\" }
  }" "$path_docker_compose_file"

  # –ø—Ä–∞–≤–∏–ª–∞ iptables
  add_iptables_rule "$port_wg" "udp"
  add_iptables_rule "$port_ui" "tcp"

  # –µ—Å–ª–∏ —Ñ–∞–π–ª caddyfile —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  if [[ -f "$path_caddyfile" ]]; then
    # reverse_proxy –≤ caddyfile 
    echo "handle_path /$service_name/* { reverse_proxy $service_name:$port_ui }" >> "$path_caddyfile"
    # c—Å—ã–ª–∫–∞ –Ω–∞ UI –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å wg-easy
    link_ui="https://${WG_HOST}/${service_name}/"
  else
    link_ui="http://${WG_HOST}:${port_ui}"
  fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è Caddy —Å–µ—Ä–≤–∏—Å–∞
add_caddy_service() {
  [[ "$is_domain" ]] || return
  
  local service_name="caddy-$service_prefix"

  # - services
  yq e -i ".services.${service_name} = {
    \"image\": \"docker.io/caddy/caddy:latest\",
    \"container_name\": \"${service_name}\",
    \"cap_add\": [\"NET_ADMIN\"],
    \"ports\": [
      \"443:443/tcp\",
      \"443:443/udp\"
    ],
    \"volumes\": [
      \"${path_caddyfile}:/etc/caddy/Caddyfile\",
      \"${service_name}-data:/data\",
      \"${service_name}-config:/config\"
    ],
    \"networks\": [\"${service_prefix}\"]
  }" "$path_docker_compose_file"

  # - volumes
  yq e -i ".volumes += {
    \"${service_name}-data\": { \"name\": \"${service_name}-data\" },
    \"${service_name}-config\": { \"name\": \"${service_name}-config\" }
  }" "$path_docker_compose_file"

  # - iptables
  add_iptables_rule "443" "udp"
  add_iptables_rule "443" "tcp"

  # - Caddyfile
  mkdir -p "$(dirname "$path_caddyfile")"
  {
    echo "$host"
    echo "tls $email"
  } > "$path_caddyfile"

  # - handle_path, –µ—Å–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º Caddy –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–æ–∫ wg
  yq -r '.services | keys[]' "$path_docker_compose_file" | while read -r service; do
    if [[ "$service" == "${service_prefix}-"* ]]; then
      local ui_port
      port_ui=$(get_env_var_from_service "$service" "PORT" "not_found")
      echo "handle_path /$service/* { reverse_proxy $service:$port_ui }" >> "$path_caddyfile"
    fi
  done
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è wg —Å–µ—Ä–≤–∏—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
create_wg_install_mode() {
  case "$install_mode" in
    "main")
      add_wg_service "$service_tag" "$port_wg" "$port_ui" "$address"
    ;;
    "proxy")
      add_wg_service "$service_tag" "$port_wg" "$port_ui" "$address" "$ss_link"
    ;;
    *)
      exiterr "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏: $install_mode"
    ;;
  esac
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —Å–ª—É–∂–±
create_services_config() {
  # –ü–æ–¥–≥—Ä—É–∂–∞–µ–º .env
  load_env

  echomsg "–°–æ–∑–¥–∞—ë–º –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥–∏ —Å–µ—Ä–≤–∏—Å–æ–≤" 1

  # Dockerfile
  mkdir -p "$(dirname "$path_dockerfile")"
  curl -fsSL -H "Cache-Control: no-cache" -H "Pragma: no-cache" \
    https://raw.githubusercontent.com/jinndi/wg-easy-breezy/main/Dockerfile \
    -o "$path_dockerfile" || {
    exiterr "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Dockerfile"
  }

  # start.sh
  mkdir -p "$(dirname "$path_start_sh")"
  curl -fsSL -H "Cache-Control: no-cache" -H "Pragma: no-cache" \
    https://raw.githubusercontent.com/jinndi/wg-easy-breezy/main/start.sh \
    -o "$path_start_sh" || {
    exiterr "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å start.sh"
  }

  # services.yml —à–∞–±–ª–æ–Ω
  mkdir -p "$(dirname "$path_docker_compose_file")"
  echo -e "services: {}\nvolumes: {}\nnetworks: {}" > "$path_docker_compose_file"

  # c–µ—Ä–≤–∏—Å Caddy —Å–µ—Ä–≤–µ—Ä–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è)
  [[ "$is_domain" ]] && add_caddy_service

  # c–µ—Ä–≤–∏—Å wg-easy-breezy –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
  create_wg_install_mode

  # networks
  yq e -i ".networks += {
    \"${service_prefix}\": {
      \"name\": \"${service_prefix}\",
      \"driver\": \"bridge\"
    }
  }" "$path_docker_compose_file"

  echook "–ö–æ–Ω—Ñ–∏–≥–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ —Å–æ–∑–¥–∞–Ω—ã"
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥–∞ sysctl –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–µ—Ç–∏
create_sysctl_config () {
  echomsg "–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ sysctl" 1

  # –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ—Ç
  mkdir -p "$(dirname "$path_sysctl_config")"
  mkdir -p "$(dirname "$path_sysctl_config_link")"
  
  # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥
  curl -fsSL -H "Cache-Control: no-cache" -H "Pragma: no-cache" \
    https://raw.githubusercontent.com/jinndi/wg-easy-breezy/main/sysctl.conf \
    -o "$path_sysctl_config"

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω
  if [ -f "$path_sysctl_config" ]; then
    # –í–∫–ª—é—á–µ–Ω–∏–µ TCP BBR –∫–æ–Ω—Ç—Ä–æ–ª—è –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏, –µ—Å–ª–∏ –Ω–µ —É–¥–∞—á–Ω–æ, —Ç–æ –ø—Ä–æ–±—É–µ–º hybla
    if modprobe -q tcp_bbr && [ -f /proc/sys/net/ipv4/tcp_congestion_control ]
    then
      echo "net.core.default_qdisc = fq" >> "$path_sysctl_config"
      echo "net.ipv4.tcp_congestion_control = bbr" >> "$path_sysctl_config"
    else
      if modprobe -q tcp_hybla && [ -f /proc/sys/net/ipv4/tcp_congestion_control ]
      then
        echo "net.ipv4.tcp_congestion_control = hybla" >> "$path_sysctl_config"
      fi
    fi

    # –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª
    ln -s "$path_sysctl_config" "$path_sysctl_config_link"

    # –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥
    sysctl -e -q -p "$path_sysctl_config_link"
    
    echook "–ö–æ–Ω—Ñ–∏–≥ sysctl —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω"
  else
    exiterr "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ sysctl –∫–æ–Ω—Ñ–∏–≥–∞"
  fi
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è systemd unit —Å–ª—É–∂–±—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏
create_systemd_unit() {
  local working_dir path_podman_compose
  working_dir="$(dirname "$path_docker_compose_file")"
  path_podman_compose=$(command -v podman-compose)

  echomsg "–°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–ª—É–∂–±—ã" 1
  {
    echo "[Unit]"
    echo "Description=wg-easy-breezy with iptables hooks via podman-compose"
    echo "After=network-online.target"
    echo "Wants=network-online.target"
    echo
    echo "[Service]"
    echo "Type=simple"
    echo "WorkingDirectory=$working_dir"
    echo "EnvironmentFile=$path_env_file"
    echo "ExecStartPre=$path_iptables_apply_script"
    echo "ExecStart=$path_podman_compose -f $path_docker_compose_file up --force-recreate --remove-orphans"
    echo "ExecStop=$path_podman_compose -f $path_docker_compose_file down --timeout 5"
    echo "ExecStopPost=$path_iptables_delete_script"
    echo "Restart=on-failure"
    echo "RestartSec=10"
    echo "LimitNOFILE=51200"
    echo
    echo "[Install]"
    echo "WantedBy=multi-user.target"
  } > "$path_systemd_unit_file"

  systemctl daemon-reexec
  systemctl daemon-reload

  echook "–°–ª—É–∂–±–∞ —Å–æ–∑–¥–∞–Ω–∞"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —á—Ç–æ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
is_all_ok_services() {
  # –µ—Å–ª–∏ —Ñ–∞–π–ª docker compose –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî false
  if [[ ! -e "$path_docker_compose_file" ]]; then
    return 1
  fi

  # –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ systemd —Å–ª—É–∂–±–∞ –∞–∫—Ç–∏–≤–Ω–∞ 
  if ! systemctl is-active --quiet wg-easy-breezy; then
    return 1
  fi

  return 0
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
start_services() {
  echomsg "–ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã" 1

  # –ó–∞–ø—É—Å–∫–∞–µ–º –¥–æ–∫–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
  systemctl enable --now wg-easy-breezy > /dev/null 2>&1
  sleep 5
  if ! systemctl is-active --quiet wg-easy-breezy; then
    echoerr "–ó–∞–ø—É—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è"
  else
    echook "–°–ª—É–∂–±–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞!"
  fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –∏ —Å–ª—É–∂–±
stop_services() {
  echomsg "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã" 1

  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
  if [[ -f "$path_docker_compose_file" ]]; then
    systemctl disable --now wg-easy-breezy > /dev/null 2>&1
    if systemctl is-active --quiet wg-easy-breezy; then
      echoerr "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å"
    else
      echook "–°–ª—É–∂–±–∞ —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!"
    fi
  else
    echoerr "–§–∞–π–ª docker-compose –Ω–µ –Ω–∞–π–¥–µ–Ω: $path_docker_compose_file"
  fi
}

# –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
switch_active_services() {
  # –ï—Å–ª–∏ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∏ —Å–ª—É–∂–±—ã —Ä–∞–±–æ—Ç–∞—é—Ç
  if is_all_ok_services; then
    stop_services
  else
    start_services
  fi

  select_menu_option
}

# –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞  —Å–µ—Ä–≤–∏—Å–æ–≤
restart_services() {
  echomsg "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã" 1
  systemctl stop wg-easy-breezy > /dev/null 2>&1
  systemctl start wg-easy-breezy > /dev/null 2>&1
  sleep 5
  if is_all_ok_services; then
    echook "–°–ª—É–∂–±–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞!"
  else
    echoerr "–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞! –í–≤–µ–¥–∏—Ç–µ 'journalctl -u wg-easy-breezy -n 30' –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–∞"
  fi
  select_menu_option
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–∑–∞ wg_easy_breezy
build_wg_easy_breezy() {
  podman build --no-cache -t wg-easy-breezy -f $path_dockerfile $path_data_dir > /dev/null 2>&1
}

# –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞–∑–∞ wg-easy-breezy
rebuild_services() {
  systemctl stop wg-easy-breezy > /dev/null 2>&1
  echomsg "–ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑ wg-easy-breezy" 1
  build_wg_easy_breezy
  sysctl -e -q -p "$path_sysctl_config_link"
  systemctl start wg-easy-breezy > /dev/null 2>&1
  select_menu_option
}

# –§—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –∏–∑ environment –ø–æ –∏–º–µ–Ω–∏ —Å–µ—Ä–≤–∏—Å–∞ 
get_env_var_from_service() {
  local service="$1"
  local var_name="$2"
  local default_value="${3:-}"

  yq -r ".services.\"$service\".environment.\"$var_name\" // \"$default_value\"" "$path_docker_compose_file"
}

# –§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ —Å–ø–∏—Å–∫–∞ —Å–ª—É–∂–± –Ω–∞ –æ—Å–Ω–æ–≤–µ compose yml —Ñ–∞–π–ª–∞
show_services_list() {
  # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
  yq -r '.services | keys[]' "$path_docker_compose_file" | while read -r service; do
    local container_status ports wg_host port_ui address ss_link 

    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ –∏–º–µ–Ω–∏ —Å–µ—Ä–≤–∏—Å–∞ (–ø–æ —á–∞—Å—Ç–∏ –∏–º–µ–Ω–∏)
    container_status=$(podman ps -a --filter "name=${service}" --format "{{.Names}} {{.Status}}" | head -n 1)

    if [[ "$container_status" == "" ]]; then
      status="\033[1;34m–Ω–µ –∑–∞–ø—É—â–µ–Ω\033[0m"
    elif echo "$container_status" | grep -q "^${service}"; then
      if echo "$container_status" | grep -q "Up"; then
        status="\033[1;32m—Ä–∞–±–æ—Ç–∞–µ—Ç\033[0m"
      else
        status="\033[1;31m–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç\033[0m"
      fi
    else
      status="–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π"
    fi

    # –ü–æ—Ä—Ç—ã –∏–∑ compose
    ports=$(yq -r ".services.\"$service\".ports | join(\", \")" "$path_docker_compose_file")
    [ -z "$ports" ] && ports="‚Äî"

    echo
    echo -e "\033[0;36m–ò–º—è —Å–µ—Ä–≤–∏—Å–∞:\033[0m $service"
    echo -e "\033[0;36m–°—Ç–∞—Ç—É—Å:\033[0m $status"
    echo -e "\033[0;36m–ü—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤:\033[0m $ports"

    # –ï—Å–ª–∏ —ç—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä wg-easy
    if [[ "$service" == "${service_prefix}-"* ]]; then
      ss_link=$(get_env_var_from_service "$service" "SS_LINK" "")
      wg_host=$(get_env_var_from_service "$service" "WG_HOST" "-")
      port_ui=$(get_env_var_from_service "$service" "PORT" "-")
      address=$(get_env_var_from_service "$service" "WG_DEFAULT_ADDRESS" "-")

      if [[ "$ss_link" ]]; then
        echo -e "\033[0;36m–ü—Ä–æ–∫—Å–∏ —Ä–µ–∂–∏–º:\033[0m –¥–∞, shadowsosks -> ${ss_link#*@}"
      else
        echo -e "\033[0;36m–ü—Ä–æ–∫—Å–∏ —Ä–µ–∂–∏–º:\033[0m –Ω–µ—Ç"
      fi

      echo -e "\033[0;36m–ê–¥—Ä–µ—Å–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ wg:\033[0m $address"
      
      if [[ "$wg_host" =~ ^([a-z0-9]([a-z0-9-]*[a-z0-9])?\.)+[a-z]{2,}$ ]]; then
        echo -e "\033[0;36m–í–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:\033[0m https://${wg_host}/${service}/"
      else
        echo -e "\033[0;36m–í–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:\033[0m http://${wg_host}:${port_ui}"
      fi
    fi

    echo "___________________________________________________"
  done
}

# –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞ wg-easy
add_new_wg_service() {
  # –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
  select_install_mode

  # —Å—á–∏—Ç—ã–≤–∞–Ω–∏–µ –≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  input_tag
  input_ss_link
  input_port
  input_address

  # –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É–∂–±—É
  systemctl stop wg-easy-breezy > /dev/null 2>&1

  # –¥–æ–±–∞–≤–ª—è–µ–º wg —Å–µ—Ä–≤–∏—Å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
  create_wg_install_mode

  # –∑–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–±—É
  systemctl start wg-easy-breezy > /dev/null 2>&1
  sleep 5

  echo
  echo -e "\033[1;32üéâ mwg-easy –¥–æ–±–∞–≤–ª–µ–Ω! \033[0m"
  echo -e "\033[0;36m–í–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: \033[1;32m$link_ui \033[0m"
  echo

  read -n1 -r -p "–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é..."
  
  # –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—é –æ–ø—Ü–∏–π
  select_menu_option
}

# –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞ wg-easy
remove_wg_service() {
  # –≤–≤–æ–¥ –∏–º–µ–Ω–∏ —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
  while true; do
    echomsg "–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è" 1
    echomsg "(Enter –±–µ–∑ –≤–≤–æ–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤ –º–µ–Ω—é)"
    read -rp " > " service_name

    if [[ -z "$service_name" ]]; then
      select_menu_option
      return
    fi

    if [[ "$(yq e ".services.\"$service_name\"" "$path_docker_compose_file")" != "null" ]]; then
      echomsg "–£–¥–∞–ª—è–µ–º —Å–µ—Ä–≤–∏—Å $service_name" 1
      break
    else
      echoerr "–°–µ—Ä–≤–∏—Å $service_name –ù–ï –Ω–∞–π–¥–µ–Ω"
    fi
  done

  local port_wg port_ui

  # –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É–∂–±—É
  systemctl stop wg-easy-breezy > /dev/null 2>&1

  # services.yml –∑–∞–ø–∏—Å–∏ services –∏ volumes
  yq e -i "del(.services.${service_name})" "$path_docker_compose_file"
  yq e -i "del(.volumes.${service_name})" "$path_docker_compose_file"

  # volume —Ç–æ–º
  # podman volume rm "$service_name" > /dev/null 2>&1

  # –ø—Ä–∞–≤–∏–ª–∞ iptables
  port_wg=$(get_env_var_from_service "$service_name" "WG_PORT" "")
  port_ui=$(get_env_var_from_service "$service_name" "PORT" "")
  remove_iptables_rule "$port_wg" "udp"
  remove_iptables_rule "$port_ui" "tcp"

  # —Ä–µ–≤–µ—Ä—Å –ø—Ä–æ–∫—Å–∏ –≤ caddyfile
  [[ -f "$path_caddyfile" ]] && sed -i "/$service_name/d" "$path_caddyfile"

  # –∑–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–±—É
  systemctl start wg-easy-breezy > /dev/null 2>&1
  sleep 5

  echook "üéà –°–µ—Ä–≤–∏—Å $service_name —É–¥–∞–ª–µ–Ω!"
  echo
  read -n1 -r -p "–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é..."
  # –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—é –æ–ø—Ü–∏–π
  select_menu_option
}

# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
install() {
  # –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
  check_root
  check_shell
  check_kernel
  check_os
  check_os_ver
  check_container

  # –ø—Ä–∏–≤–µ—Ç—Å–≤–∏–µ
  show_header
  read -n1 -r -p "–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É..."

  # —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—É—â–µ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –µ—Å–ª–∏ –±—ã–ª–∞
  # –∏ –æ—Å—Ç–∞–ª–∏—Å—å —Ñ–∞–π–ª—ã –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–π
  remove_install

  # —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  install_pkgs

  # –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
  select_install_mode

  # —Å–æ–∑–¥–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –ø–∞–ø–∫–∏ –∏ —Ñ–∞–π–ª—ã
  mkdir -p "$path_data_dir"
  mkdir -p "$(dirname "$path_script")"
  mkdir -p "$(dirname "$path_env_file")"
  {
    echo "LANG=ru"
    echo "WG_DEFAULT_DNS=1.1.1.1"
    echo "UI_TRAFFIC_STATS=true"
  } > "$path_env_file"

  # —Å—á–∏—Ç—ã–≤–∞–Ω–∏–µ –≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  input_tag
  input_domain
  input_email
  input_ss_link
  input_port
  input_address
  input_password

  # –ø–æ–∏—Å–∫ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ MTU WireGuard
  find_optimal_wg_mtu

  # —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–æ–≤ iptables –ø—Ä–∞–≤–∏–ª
  create_iptables_scripts

  # —Å–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ –¥–æ–∫–µ—Ä —Å–µ—Ä–≤–∏—Å–æ–≤
  create_services_config

  # —Å–æ–∑–¥–∞–Ω–∏–µ sysctl –∫–æ–Ω—Ñ–∏–≥–∞
  create_sysctl_config

  # —Å–æ–∑–¥–∞–Ω–∏–µ systemd unit —Å–ª—É–∂–±—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏
  create_systemd_unit

  # –±–∏–ª–¥–∏–º –æ–±—Ä–∞–∑ wg-easy-breezy
  build_wg_easy_breezy

  # –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
  start_services
  
  echo
  echo -e "\033[1;32müéâ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! \033[0m"
  echo -e "\033[0;36m–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã: \033[1;32m$path_data_dir \033[0m"
  echo -e "\033[0;36m–í–µ–± –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: \033[1;32m$link_ui \033[0m"
  echo

  # –ø–µ—Ä–µ–º–µ—â–∞–º —Ç–µ–∫—É—â–∏–π —Å–∫—Ä–∏–ø—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –Ω–∞ –Ω–µ–≥–æ –ø—Ä–∞–≤–∞ –∏ —Å—Å—ã–ª–∫—É
  mv "$(realpath "$0")" "$path_script"
  chmod +x "$path_script"
  ln -s "$path_script" "$path_script_link"

  read -n1 -r -p "–ù–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–ª–∞–≤–∏—à—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é..."

  # –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—é –æ–ø—Ü–∏–π
  select_menu_option
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
remove_services() {
  echo
  local msg
  msg="–£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ? [y/N]: "
  read -rp "$msg" remove

  until [[ "$remove" =~ ^[yYnN–¥–î–Ω–ù]$ ]]; do
    echo "$remove: –Ω–µ–≤–µ—Ä–Ω–∞—è –æ–ø—Ü–∏—è."
    read -rp "$msg" remove
  done

  if [[ "$remove" =~ ^[yY–¥–î]$ ]]; then
    remove_install "1"
    exit 0
  else
    select_menu_option
  fi
}

# –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
select_install_mode() {
  echo
  echo "–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
  echo " 1) –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π wg-easy"
  echo " 2) –ü—Ä–æ–∫—Å–∏ wg-easy -> shasowsocks"

  read -rp "–í—ã–±–æ—Ä: " mode
  until [[ "$mode" =~ ^[1-2]$ ]]; do
    echoerr "$option: –Ω–µ–≤–µ—Ä–Ω–∞—è –æ–ø—Ü–∏—è."
    read -rp "–í—ã–±–æ—Ä: " mode
  done

  case "$mode" in
    1)
      install_mode="main"
    ;;
    2)
      install_mode="proxy"
    ;;
  esac
}

# –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–µ–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏
add_domain() {
  input_domain
  input_email
  if [[ "$is_domain" ]]; then
    # –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É–∂–±—É
    systemctl stop wg-easy-breezy > /dev/null 2>&1

    # –¥–æ–±–∞–≤–ª—è–µ–º caddy —Å–µ—Ä–≤–µ—Ä —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π —Ä–µ–≤–µ—Ä—Å–ø—Ä–æ–∫—Å–∏
    add_caddy_service

    # –ø–æ–¥–Ω–∏–º–∞–µ–º  —Å–ª—É–∂–±—É
    systemctl start wg-easy-breezy > /dev/null 2>&1

    echook "üéâ –î–æ–º–µ–Ω '$host' –¥–æ–±–∞–≤–ª–µ–Ω –∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"
  fi
  select_domain_option
}

# –§—É–Ω–∫—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ–º–µ–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏
change_domain() {
  host=""

  while true; do
    echomsg "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è" 1
    echoerr "–ü–æ—Å–ª–µ —Å–º–µ–Ω—ã —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ wg –∫–æ–Ω—Ñ–∏–≥–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤"
    echoerr "—Ç—Ä–µ–±—É—é—Ç –∑–∞–º–µ–Ω—ã –ª–∏–±–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞ –ø–∏—Ä–∞."
    echomsg "(–Ω–∞–∂–º–∏—Ç–µ Enter —Å –ø—É—Å—Ç—ã–º –≤–≤–æ–¥–æ–º –¥–ª—è –æ—Ç–º–µ–Ω—ã)"
    read -rp " > " host
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π –≤–≤–æ–¥
    if [ -z "$host" ]; then
      break
    else
      # –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ punycode (–Ω–∞ —Å–ª—É—á–∞–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã) —Å –Ω–∏–∂–Ω–∏–º —Ä–µ–≥–∏—Å—Ç—Ä–æ–º
      host=$(idn "$host" | tr '[:upper:]' '[:lower:]')
      # –µ—Å–ª–∏ –ø—Ä–æ—à–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É
      if check_domain "$host"; then
        echomsg "–ü—Ä–∏–º–µ–Ω—è–µ–º –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è '$host'" 1

        # –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É–∂–±—É
        systemctl stop wg-easy-breezy > /dev/null 2>&1

        # –∑–∞–º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ .env
        if grep -q '^WG_HOST=' "$path_env_file"; then
          sed -i "s/^WG_HOST=.*/WG_HOST=$host/" "$path_env_file"
        else
          echo "WG_HOST=$host" >> "$path_env_file"
        fi

        # –∑–∞–º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ Caddyfile
        if grep -q "^$WG_HOST" "$path_caddyfile"; then
          sed -i "s/^$WG_HOST/$host/" "$path_caddyfile"
        else
          sed -i "1i $host" "$path_caddyfile"
        fi

        # –ø–æ–¥–Ω–∏–º–∞–µ–º  —Å–ª—É–∂–±—É
        systemctl start wg-easy-breezy > /dev/null 2>&1

        echook "üéâ –î–æ–º–µ–Ω '$WG_HOST' –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ '$host'"
        break
      fi
    fi
  done

  select_domain_option
}

# –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–º–µ–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏
remove_domain() {
  local msg
  echo
  echoerr "–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–º–µ–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏,"
  echoerr "—Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ wg –∫–æ–Ω—Ñ–∏–≥–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤"
  echoerr "—Ç—Ä–µ–±—É—é—Ç –∑–∞–º–µ–Ω—ã –ª–∏–±–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞ –ø–∏—Ä–∞."
  msg="–£–¥–∞–ª—è–µ–º? [y/N]: "
  read -rp "$msg" remove

  until [[ "$remove" =~ ^[yYnN–¥–î–Ω–ù]$ ]]; do
    echo "$remove: –Ω–µ–≤–µ—Ä–Ω–∞—è –æ–ø—Ü–∏—è."
    read -rp "$msg" remove
  done

  if [[ "$remove" =~ ^[yY–¥–î]$ ]]; then
    local service_name="caddy-$service_prefix"

    echomsg "–£–¥–∞–ª—è–µ–º –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è '$WG_HOST'" 1

    # –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ª—É–∂–±—É
    systemctl stop wg-easy-breezy > /dev/null 2>&1

    # services.yml –∑–∞–ø–∏—Å–∏ services –∏ volumes
    yq e -i "del(.services.${service_name})" "$path_docker_compose_file" > /dev/null 2>&1
    yq e -i "del(.volumes.${service_name}-data)" "$path_docker_compose_file" > /dev/null 2>&1
    yq e -i "del(.volumes.${service_name}-config)" "$path_docker_compose_file" > /dev/null 2>&1

    # –ø—Ä–∞–≤–∏–ª–∞ iptables
    remove_iptables_rule "443" "udp"
    remove_iptables_rule "443" "tcp"

    # caddyfile
    [[ -f "$path_caddyfile" ]] && rm "$path_caddyfile"

    # –∑–∞–º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ .env
    host=$(get_public_ip)
    if grep -q '^WG_HOST=' "$path_env_file"; then
      sed -i "s/^WG_HOST=.*/WG_HOST=$host/" "$path_env_file"
    else
      echo "WG_HOST=$host" >> "$path_env_file"
    fi

    # –∑–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–±—É
    systemctl start wg-easy-breezy > /dev/null 2>&1
    sleep 5

    echook "üéà –î–æ–º–µ–Ω–Ω–æ–µ –∏–º—è '$WG_HOST' —É–¥–∞–ª–µ–Ω–æ!"
  fi

  select_domain_option
}

# –§—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏ –¥–æ–º–º–µ–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º
select_domain_option() {
  # –≥—Ä—É–∑–∏–º .env
  load_env

  # –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ª–∏ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è
  local is__domain=""
  [[ -f "$path_caddyfile" ]] &&  \
  [[ "$WG_HOST" =~ ^([a-z0-9]([a-z0-9-]*[a-z0-9])?\.)+[a-z]{2,}$ ]] && \
  is__domain="true"

  echo
  if [[ "$is__domain" ]]; then 
    echook "\033[0;36m–í–∞—à –¥–æ–º–µ–Ω:\033[0m $WG_HOST"
  else
    echoerr "–î–æ–º–µ–Ω–Ω–æ–µ –∏–º—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
  fi
  echo
  echo "–í—ã–±–µ—Ä–∏–µ –æ–ø—Ü–∏—é:"

  if [[ "$is__domain" ]]; then
    echo " 1) –°–º–µ–Ω–∏—Ç—å –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è"
    echo " 2) –£–¥–∞–ª–∏—Ç—å –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è"
    echo " 3) –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"
    read -rp "–í—ã–±–æ—Ä: " action

    until [[ "$action" =~ ^[1-3]$ ]]; do
      echoerr "$action: –Ω–µ–≤–µ—Ä–Ω–∞—è –æ–ø—Ü–∏—è."
      read -rp "–í—ã–±–æ—Ä: " action
    done

    case "$action" in
      1)
        change_domain
      ;;
      2)
        remove_domain
      ;;
      3)
        select_menu_option
      ;;
    esac
  else
    echo " 1) –î–æ–±–∞–≤–∏—Ç—å –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è"
    echo " 2) –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é"
    read -rp "–í—ã–±–æ—Ä: " action

    until [[ "$action" =~ ^[1-2]$ ]]; do
      echoerr "$action: –Ω–µ–≤–µ—Ä–Ω–∞—è –æ–ø—Ü–∏—è."
      read -rp "–í—ã–±–æ—Ä: " action
    done

    case "$action" in
      1)
        add_domain
      ;;
      2)
        select_menu_option
      ;;
    esac
  fi
}

# –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –æ–ø—Ü–∏–π
select_menu_option() {
  show_header
  show_services_list
  echo

  local select_option="–ú–µ–Ω—é –æ–ø—Ü–∏–π:"

  if is_all_ok_services; then
    echo "üü¢ –°–ª—É–∂–±–∞ systemctl –∞–∫—Ç–∏–≤–Ω–∞"
    echo
    echo "$select_option"
    echo " 1) ‚ùå –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
  else
    echo "üî¥ –°–ª—É–∂–±–∞ systemctl –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞"
    echo
    echo "$select_option"
    echo " 1) üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã"
  fi
  echo " 2) üåÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã" 
  echo " 3) üì¶ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä wg-easy"
  echo " 4) üßπ –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä wg-easy"
  echo " 5) üåê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–º–µ–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º"
  echo " 6) üßø –°—Ç–∞—Ç—É—Å systemctl —Å–ª—É–∂–±—ã"
  echo " 7) üìú –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ journalctl"
  echo " 8) üîÆ –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑ wg-easy"
  echo " 9) ü™£ –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã"
  echo " 10) üö™ –í—ã—Ö–æ–¥ –∏–∑ –º–µ–Ω—é (Ctrl+C)"

  read -rp "–û–ø—Ü–∏—è: " option
  until [[ "$option" =~ ^[1-8]$ ]]; do
    echoerr "$option: –Ω–µ–≤–µ—Ä–Ω–∞—è –æ–ø—Ü–∏—è."
    read -rp "–û–ø—Ü–∏—è: " option
  done

  case "$option" in
    1)
      switch_active_services
    ;;
    2)
      restart_services
    ;;
    3)
      add_new_wg_service
    ;;
    4)
      remove_wg_service
    ;;
    5)
      select_domain_option
    ;;
    6)
      systemctl status wg-easy-breezy --no-pager -l
      select_menu_option
    ;;
    7)
      journalctl -u wg-easy-breezy -n 100 --no-pager
      select_menu_option
    ;;
    8)
      rebuild_services
    ;;
    9)–¶
      remove_services
    ;;
    10)
      exit 0
    ;;
  esac
}

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env —Ñ–∞–π–ª–∞
load_env

if [[ -d "$path_data_dir" ]]; then
  select_menu_option
else
  install
fi